# „Éá„Éó„É≠„Ç§„É°„É≥„Éà„Éª„Ç§„É≥„Éï„É©„Çπ„Éà„É©„ÇØ„ÉÅ„É£Ë®≠Ë®à

**„Éâ„Ç≠„É•„É°„É≥„Éà„Éê„Éº„Ç∏„Éß„É≥**: 1.0.0  
**‰ΩúÊàêÊó•**: 2025-10-27  
**„Çπ„ÉÜ„Éº„Çø„Çπ**: Draft

---

## üìã Ê¶ÇË¶Å

Êú¨„Éâ„Ç≠„É•„É°„É≥„Éà„ÅØ„ÄÅSDS2Roster„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éá„Éó„É≠„Ç§„É°„É≥„ÉàÊà¶Áï•„ÄÅCI/CD„Éë„Ç§„Éó„É©„Ç§„É≥„ÄÅ„Ç§„É≥„Éï„É©„Çπ„Éà„É©„ÇØ„ÉÅ„É£Ë®≠Ë®àÔºàInfrastructure as CodeÔºâ„ÇíÂÆöÁæ©„Åó„Åæ„Åô„ÄÇ

**ÂØæË±°Ë™≠ËÄÖ**:
- DevOps„Ç®„É≥„Ç∏„Éã„Ç¢
- „Ç§„É≥„Éï„É©„Ç®„É≥„Ç∏„Éã„Ç¢
- „Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖ
- ÈñãÁô∫„ÉÅ„Éº„É†

---

## üéØ „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÂéüÂâá

### 1. Infrastructure as Code (IaC)
- **Terraform‰ΩøÁî®**: „Åô„Åπ„Å¶„ÅÆAzure„É™„ÇΩ„Éº„Çπ„Çí„Ç≥„Éº„Éâ„ÅßÁÆ°ÁêÜ
- **„Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ**: Terraform„Ç≥„Éº„Éâ„ÅØ„Åô„Åπ„Å¶Git„ÅßÁÆ°ÁêÜ
- **ÂÜçÁèæÊÄß**: Áí∞Â¢É„Çí„ÅÑ„Å§„Åß„ÇÇÂÜç‰ΩúÊàêÂèØËÉΩ

### 2. Ëá™ÂãïÂåñÂÑ™ÂÖà
- **ÊâãÂãï‰ΩúÊ•≠ÊúÄÂ∞èÂåñ**: „Éá„Éó„É≠„Ç§„ÅØ„Åô„Åπ„Å¶CI/CD„Éë„Ç§„Éó„É©„Ç§„É≥ÁµåÁî±
- **ÊâøË™ç„Éï„É≠„Éº**: Êú¨Áï™„Éá„Éó„É≠„Ç§„Å´„ÅØÊâøË™ç„Ç≤„Éº„ÉàÂøÖÈ†à
- **„É≠„Éº„É´„Éê„ÉÉ„ÇØ**: „ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„É≠„Éº„É´„Éê„ÉÉ„ÇØÂèØËÉΩ

### 3. Blue-Green Deployment
- **„Çº„É≠„ÉÄ„Ç¶„É≥„Çø„Ç§„É†**: Êú¨Áï™Áí∞Â¢É„Å∏„ÅÆÂΩ±Èüø„ÇíÊúÄÂ∞èÂåñ
- **ÊÆµÈöéÁöÑ„É≠„Éº„É´„Ç¢„Ç¶„Éà**: „Ç´„Éä„É™„Ç¢„É™„É™„Éº„ÇπÂØæÂøú
- **Âç≥Â∫ß„ÅÆ„É≠„Éº„É´„Éê„ÉÉ„ÇØ**: ÂïèÈ°åÁô∫ÁîüÊôÇ„ÅØÊóß„Éê„Éº„Ç∏„Éß„É≥„Å´Âàá„ÇäÊõø„Åà

### 4. Áí∞Â¢ÉÂàÜÈõ¢
- **Áã¨Á´ã„Åó„ÅüÁí∞Â¢É**: ÈñãÁô∫„Éª„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„ÉªÊú¨Áï™„ÇíÂÆåÂÖ®ÂàÜÈõ¢
- **„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„ÉóÂàÜÈõ¢**: Áí∞Â¢É„Åî„Å®„Å´Áã¨Á´ã„Åó„ÅüAzure„É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó
- **Ë®≠ÂÆöÁÆ°ÁêÜ**: Áí∞Â¢É„Åî„Å®„ÅÆË®≠ÂÆö„ÇíKey Vault„ÅßÁÆ°ÁêÜ

---

## üèóÔ∏è Áí∞Â¢ÉÊßãÊàê

### Áí∞Â¢É‰∏ÄË¶ß

| Áí∞Â¢É | ÁõÆÁöÑ | „Éá„Éó„É≠„Ç§È†ªÂ∫¶ | ÊâøË™çË¶ÅÂê¶ |
|------|------|------------|---------|
| **ÈñãÁô∫ (dev)** | Ê©üËÉΩÈñãÁô∫„ÉªÂçò‰Ωì„ÉÜ„Çπ„Éà | 1Êó•Ë§áÊï∞Âõû | ‰∏çË¶Å |
| **„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞ (stg)** | Áµ±Âêà„ÉÜ„Çπ„Éà„ÉªÊ§úË®º | ÈÄ±1-2Âõû | ‰∏çË¶Å |
| **Êú¨Áï™ (prod)** | Êú¨Áï™ÈÅãÁî® | Êúà2Âõû | **ÂøÖÈ†à** |

### „É™„ÇΩ„Éº„ÇπÂëΩÂêçË¶èÂâá

```
„Éë„Çø„Éº„É≥: {service}-{project}-{env}-{region}

‰æã:
- func-sds2roster-dev-japaneast
- st-sds2roster-prod-japaneast
- kv-sds2roster-prod-japaneast
- rg-sds2roster-dev
- rg-sds2roster-prod
```

### Áí∞Â¢ÉË©≥Á¥∞

#### ÈñãÁô∫Áí∞Â¢É (dev)

| „É™„ÇΩ„Éº„Çπ | ÂêçÁß∞ | SKU/Tier | Áî®ÈÄî |
|---------|------|----------|------|
| Function App (Python) | func-sds2roster-py-dev | Consumption | PythonÁâàÈñãÁô∫ |
| Function App (JavaScript) | func-sds2roster-js-dev | Consumption | JavaScriptÁâàÈñãÁô∫ |
| Storage Account | stsds2rosterdev | Standard LRS | „Éï„Ç°„Ç§„É´‰øùÂ≠ò |
| Table Storage | stsds2rosterdev | Standard | „Ç∏„Éß„ÉñÂ±•Ê≠¥ |
| Key Vault | kv-sds2roster-dev | Standard | „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÁÆ°ÁêÜ |
| Application Insights | appi-sds2roster-dev | - | Áõ£Ë¶ñ„Éª„É≠„Ç∞ |
| „É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó | rg-sds2roster-dev | - | „É™„ÇΩ„Éº„ÇπÁÆ°ÁêÜ |

**ÁâπÂæ¥**:
- ‰Ωé„Ç≥„Çπ„ÉàÂÑ™ÂÖàÔºàConsumption PlanÔºâ
- LRSÔºà„É≠„Éº„Ç´„É´ÂÜóÈï∑„Çπ„Éà„É¨„Éº„Ç∏Ôºâ
- ÈñãÁô∫ËÄÖÂÖ®Âì°„Åå„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ

#### „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É (stg)

| „É™„ÇΩ„Éº„Çπ | ÂêçÁß∞ | SKU/Tier | Áî®ÈÄî |
|---------|------|----------|------|
| Function App (Python) | func-sds2roster-py-stg | Premium EP1 | PythonÁâàÊ§úË®º |
| Function App (JavaScript) | func-sds2roster-js-stg | Premium EP1 | JavaScriptÁâàÊ§úË®º |
| Storage Account | stsds2rosterstg | Standard ZRS | „Éï„Ç°„Ç§„É´‰øùÂ≠ò |
| Table Storage | stsds2rosterstg | Standard | „Ç∏„Éß„ÉñÂ±•Ê≠¥ |
| Key Vault | kv-sds2roster-stg | Standard | „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÁÆ°ÁêÜ |
| Application Insights | appi-sds2roster-stg | - | Áõ£Ë¶ñ„Éª„É≠„Ç∞ |
| „É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó | rg-sds2roster-stg | - | „É™„ÇΩ„Éº„ÇπÁÆ°ÁêÜ |

**ÁâπÂæ¥**:
- Êú¨Áï™ÂêåÁ≠âÊßãÊàê
- ZRSÔºà„Çæ„Éº„É≥ÂÜóÈï∑„Çπ„Éà„É¨„Éº„Ç∏Ôºâ
- Êú¨Áï™Áõ∏ÂΩì„ÅÆË≤†Ëç∑„ÉÜ„Çπ„ÉàÂèØËÉΩ

#### Êú¨Áï™Áí∞Â¢É (prod)

| „É™„ÇΩ„Éº„Çπ | ÂêçÁß∞ | SKU/Tier | Áî®ÈÄî |
|---------|------|----------|------|
| Function App (Python) | func-sds2roster-py-prod | Premium EP2 | PythonÁâàÊú¨Áï™ |
| Function App (JavaScript) | func-sds2roster-js-prod | Premium EP2 | JavaScriptÁâàÊú¨Áï™ |
| Storage Account (FunctionÁî®) | stsds2rosterfnprod | Standard ZRS | FunctionÂ∞ÇÁî® |
| Storage Account („Éá„Éº„ÇøÁî®) | stsds2rosterdataprod | Standard ZRS | CSVÂÖ•Âá∫Âäõ |
| Table Storage | stsds2rosterdataprod | Standard | „Ç∏„Éß„ÉñÂ±•Ê≠¥ |
| Key Vault | kv-sds2roster-prod | Standard | „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÁÆ°ÁêÜ |
| Application Insights | appi-sds2roster-prod | - | Áõ£Ë¶ñ„Éª„É≠„Ç∞ |
| „É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó | rg-sds2roster-prod | - | „É™„ÇΩ„Éº„ÇπÁÆ°ÁêÜ |

**ÁâπÂæ¥**:
- È´òÂèØÁî®ÊÄß„ÉªÈ´òÊÄßËÉΩÔºàPremium EP2Ôºâ
- Storage AccountÂàÜÈõ¢ÔºàFunctionÁî®/„Éá„Éº„ÇøÁî®Ôºâ
- ZRSÔºà„Çæ„Éº„É≥ÂÜóÈï∑„Çπ„Éà„É¨„Éº„Ç∏Ôºâ
- Êú¨Áï™ÈÅãÁî®Áõ£Ë¶ñ„Éª„Ç¢„É©„Éº„Éà

---

## üîÑ CI/CD„Éë„Ç§„Éó„É©„Ç§„É≥

### GitHub Actions„ÉØ„Éº„ÇØ„Éï„É≠„Éº

#### ÂÖ®‰Ωì„Éï„É≠„ÉºÂõ≥

```mermaid
graph TD
    A[Git Push] --> B{„Éñ„É©„É≥„ÉÅÂà§ÂÆö}
    B -->|develop| C[ÈñãÁô∫Áí∞Â¢É„Éá„Éó„É≠„Ç§]
    B -->|staging| D[„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Éá„Éó„É≠„Ç§]
    B -->|main| E[Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§]
    
    C --> F[Lint & Format]
    D --> F
    E --> F
    
    F --> G[Unit Tests]
    G --> H[Integration Tests]
    H --> I[Security Scan]
    I --> J[Build Artifacts]
    
    J --> K{Áí∞Â¢ÉÂà§ÂÆö}
    K -->|dev| L[Deploy to Dev]
    K -->|stg| M[Deploy to Staging]
    K -->|prod| N[ÊâøË™ç„Ç≤„Éº„Éà]
    
    N --> O[Terraform Plan]
    O --> P[ÊâøË™çÂæÖ„Å°]
    P --> Q[Terraform Apply]
    Q --> R[Deploy to Prod]
    
    L --> S[Smoke Tests]
    M --> S
    R --> S
    
    S --> T[ÈÄöÁü•: Teams/Slack]
```

### „ÉØ„Éº„ÇØ„Éï„É≠„ÉºÂÆöÁæ©

#### 1. ÈñãÁô∫Áí∞Â¢É„Éá„Éó„É≠„Ç§Ôºà`.github/workflows/deploy-dev.yml`Ôºâ

```yaml
name: Deploy to Development

on:
  push:
    branches:
      - develop

env:
  AZURE_FUNCTIONAPP_NAME_PY: func-sds2roster-py-dev
  AZURE_FUNCTIONAPP_NAME_JS: func-sds2roster-js-dev
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Python Lint & Test
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: |
          cd src/python
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run Python linters
        run: |
          cd src/python
          black --check .
          flake8 .
          mypy .
      
      - name: Run Python tests
        run: |
          cd src/python
          pytest --cov=. --cov-report=xml
      
      # JavaScript Lint & Test
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install JS dependencies
        run: |
          cd src/javascript
          npm ci
      
      - name: Run JS linters
        run: |
          cd src/javascript
          npm run lint
      
      - name: Run JS tests
        run: |
          cd src/javascript
          npm run test:coverage

  deploy-python:
    needs: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      
      - name: Deploy Python Function App
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME_PY }}
          package: './src/python'
          python-version: ${{ env.PYTHON_VERSION }}

  deploy-javascript:
    needs: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      
      - name: Deploy JS Function App
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME_JS }}
          package: './src/javascript'

  smoke-tests:
    needs: [deploy-python, deploy-javascript]
    runs-on: ubuntu-latest
    steps:
      - name: Run smoke tests
        run: |
          # Âü∫Êú¨ÁöÑ„Å™„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          curl -f https://${AZURE_FUNCTIONAPP_NAME_PY}.azurewebsites.net/api/health
          curl -f https://${AZURE_FUNCTIONAPP_NAME_JS}.azurewebsites.net/api/health

  notify:
    needs: [smoke-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Notify Teams
        uses: aliencube/microsoft-teams-actions@v0.8.0
        with:
          webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "Development Deployment Success"
          summary: "SDS2Roster dev environment deployed successfully"
```

#### 2. Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§Ôºà`.github/workflows/deploy-prod.yml`Ôºâ

```yaml
name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

env:
  AZURE_FUNCTIONAPP_NAME_PY: func-sds2roster-py-prod
  AZURE_FUNCTIONAPP_NAME_JS: func-sds2roster-js-prod
  TERRAFORM_VERSION: '1.5.0'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  terraform-plan:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: |
          cd terraform/environments/prod
          terraform init -backend-config="key=prod.tfstate"
      
      - name: Terraform Plan
        run: |
          cd terraform/environments/prod
          terraform plan -out=tfplan
      
      - name: Upload Plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: terraform/environments/prod/tfplan

  approval-gate:
    needs: terraform-plan
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://func-sds2roster-py-prod.azurewebsites.net
    steps:
      - name: Wait for approval
        run: echo "Waiting for manual approval..."

  terraform-apply:
    needs: approval-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Download Plan
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan
          path: terraform/environments/prod
      
      - name: Terraform Apply
        run: |
          cd terraform/environments/prod
          terraform init -backend-config="key=prod.tfstate"
          terraform apply tfplan

  deploy-functions:
    needs: terraform-apply
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [python, javascript]
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: Deploy Function App
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ matrix.language == 'python' && env.AZURE_FUNCTIONAPP_NAME_PY || env.AZURE_FUNCTIONAPP_NAME_JS }}
          package: './src/${{ matrix.language }}'
          slot-name: 'staging'

  swap-slots:
    needs: deploy-functions
    runs-on: ubuntu-latest
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: Swap Python slots
        run: |
          az functionapp deployment slot swap \
            --resource-group rg-sds2roster-prod \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_PY }} \
            --slot staging \
            --target-slot production
      
      - name: Swap JS slots
        run: |
          az functionapp deployment slot swap \
            --resource-group rg-sds2roster-prod \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_JS }} \
            --slot staging \
            --target-slot production

  post-deployment-tests:
    needs: swap-slots
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run integration tests
        run: |
          cd tests/integration
          npm ci
          npm run test:prod
      
      - name: Monitor error rate
        run: |
          # Application Insights„Åß„Ç®„É©„ÉºÁéá„ÇíÁ¢∫Ë™ç
          # 5%‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØËá™Âãï„É≠„Éº„É´„Éê„ÉÉ„ÇØ
          ERROR_RATE=$(az monitor app-insights metrics show \
            --app appi-sds2roster-prod \
            --metric requests/failed \
            --interval PT5M \
            --query "value.data[-1].average" \
            --output tsv)
          
          if (( $(echo "$ERROR_RATE > 5" | bc -l) )); then
            echo "Error rate too high: $ERROR_RATE%"
            exit 1
          fi

  rollback-on-failure:
    needs: post-deployment-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: Rollback Python
        run: |
          az functionapp deployment slot swap \
            --resource-group rg-sds2roster-prod \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_PY }} \
            --slot production \
            --target-slot staging
      
      - name: Rollback JS
        run: |
          az functionapp deployment slot swap \
            --resource-group rg-sds2roster-prod \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_JS }} \
            --slot production \
            --target-slot staging
      
      - name: Notify failure
        uses: aliencube/microsoft-teams-actions@v0.8.0
        with:
          webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "üö® Production Deployment Failed - Rolled Back"
          summary: "Deployment failed and was automatically rolled back"
```

---

## üèóÔ∏è TerraformÊßãÊàê

### „Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†

```
terraform/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ function-app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ key-vault/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îÇ       ‚îú‚îÄ‚îÄ main.tf
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf
‚îÇ       ‚îî‚îÄ‚îÄ outputs.tf
‚îÇ
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îú‚îÄ‚îÄ dev/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backend.tf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ stg/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backend.tf
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ prod/
‚îÇ       ‚îú‚îÄ‚îÄ main.tf
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf
‚îÇ       ‚îú‚îÄ‚îÄ terraform.tfvars
‚îÇ       ‚îî‚îÄ‚îÄ backend.tf
‚îÇ
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ providers.tf
‚îÇ   ‚îú‚îÄ‚îÄ versions.tf
‚îÇ   ‚îî‚îÄ‚îÄ locals.tf
‚îÇ
‚îî‚îÄ‚îÄ README.md
```

### „É°„Ç§„É≥Terraform„Ç≥„Éº„Éâ‰æã

#### terraform/environments/prod/main.tf

```hcl
terraform {
  required_version = ">= 1.5.0"
  
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.75.0"
    }
  }
  
  backend "azurerm" {
    resource_group_name  = "rg-terraform-state"
    storage_account_name = "stterraformstate"
    container_name       = "tfstate"
    key                  = "prod.tfstate"
  }
}

provider "azurerm" {
  features {
    key_vault {
      purge_soft_delete_on_destroy = false
      recover_soft_deleted_key_vaults = true
    }
  }
}

# „É≠„Éº„Ç´„É´Â§âÊï∞
locals {
  project      = "sds2roster"
  environment  = "prod"
  location     = "japaneast"
  
  tags = {
    Project     = "SDS2Roster"
    Environment = "Production"
    ManagedBy   = "Terraform"
    CostCenter  = "IT-Education"
  }
}

# „É™„ÇΩ„Éº„Çπ„Ç∞„É´„Éº„Éó
resource "azurerm_resource_group" "main" {
  name     = "rg-${local.project}-${local.environment}"
  location = local.location
  tags     = local.tags
}

# Storage Account (FunctionÁî®)
module "storage_function" {
  source = "../../modules/storage"
  
  name                = "st${local.project}fn${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  account_tier             = "Standard"
  account_replication_type = "ZRS"
  
  enable_https_traffic_only = true
  min_tls_version          = "TLS1_2"
  
  tags = local.tags
}

# Storage Account („Éá„Éº„ÇøÁî®)
module "storage_data" {
  source = "../../modules/storage"
  
  name                = "st${local.project}data${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  account_tier             = "Standard"
  account_replication_type = "ZRS"
  
  enable_https_traffic_only = true
  min_tls_version          = "TLS1_2"
  
  # Blob containers
  containers = [
    "sds-input",
    "oneroster-output"
  ]
  
  tags = local.tags
}

# Key Vault
module "key_vault" {
  source = "../../modules/key-vault"
  
  name                = "kv-${local.project}-${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  sku_name = "standard"
  
  enabled_for_deployment          = false
  enabled_for_disk_encryption     = false
  enabled_for_template_deployment = false
  
  enable_rbac_authorization = true
  purge_protection_enabled  = true
  
  network_acls = {
    bypass         = "AzureServices"
    default_action = "Deny"
  }
  
  tags = local.tags
}

# Application Insights
module "monitoring" {
  source = "../../modules/monitoring"
  
  name                = "appi-${local.project}-${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  application_type = "web"
  
  daily_data_cap_in_gb = 10
  retention_in_days    = 90
  
  tags = local.tags
}

# Python Function App
module "function_app_python" {
  source = "../../modules/function-app"
  
  name                = "func-${local.project}-py-${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  os_type  = "Linux"
  runtime  = "python"
  version  = "3.11"
  
  service_plan_sku_name = "EP2"
  
  storage_account_name       = module.storage_function.name
  storage_account_access_key = module.storage_function.primary_access_key
  
  app_settings = {
    APPINSIGHTS_INSTRUMENTATIONKEY = module.monitoring.instrumentation_key
    KEY_VAULT_URL                  = module.key_vault.vault_uri
    DATA_STORAGE_CONNECTION_STRING = module.storage_data.primary_connection_string
    FUNCTIONS_WORKER_RUNTIME       = "python"
    AzureWebJobsFeatureFlags       = "EnableWorkerIndexing"
  }
  
  identity_type = "SystemAssigned"
  
  tags = local.tags
}

# JavaScript Function App
module "function_app_javascript" {
  source = "../../modules/function-app"
  
  name                = "func-${local.project}-js-${local.environment}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  
  os_type  = "Linux"
  runtime  = "node"
  version  = "20"
  
  service_plan_sku_name = "EP2"
  
  storage_account_name       = module.storage_function.name
  storage_account_access_key = module.storage_function.primary_access_key
  
  app_settings = {
    APPINSIGHTS_INSTRUMENTATIONKEY = module.monitoring.instrumentation_key
    KEY_VAULT_URL                  = module.key_vault.vault_uri
    DATA_STORAGE_CONNECTION_STRING = module.storage_data.primary_connection_string
    FUNCTIONS_WORKER_RUNTIME       = "node"
    WEBSITE_NODE_DEFAULT_VERSION   = "~20"
  }
  
  identity_type = "SystemAssigned"
  
  tags = local.tags
}

# RBAC: Function Apps ‚Üí Key Vault
resource "azurerm_role_assignment" "function_python_kv" {
  scope                = module.key_vault.id
  role_definition_name = "Key Vault Secrets User"
  principal_id         = module.function_app_python.principal_id
}

resource "azurerm_role_assignment" "function_javascript_kv" {
  scope                = module.key_vault.id
  role_definition_name = "Key Vault Secrets User"
  principal_id         = module.function_app_javascript.principal_id
}

# RBAC: Function Apps ‚Üí Storage Data
resource "azurerm_role_assignment" "function_python_storage" {
  scope                = module.storage_data.id
  role_definition_name = "Storage Blob Data Contributor"
  principal_id         = module.function_app_python.principal_id
}

resource "azurerm_role_assignment" "function_javascript_storage" {
  scope                = module.storage_data.id
  role_definition_name = "Storage Blob Data Contributor"
  principal_id         = module.function_app_javascript.principal_id
}
```

#### terraform/modules/function-app/main.tf

```hcl
variable "name" {
  description = "Function App name"
  type        = string
}

variable "resource_group_name" {
  description = "Resource group name"
  type        = string
}

variable "location" {
  description = "Azure region"
  type        = string
}

variable "os_type" {
  description = "OS type (Linux/Windows)"
  type        = string
  default     = "Linux"
}

variable "runtime" {
  description = "Runtime (python/node)"
  type        = string
}

variable "version" {
  description = "Runtime version"
  type        = string
}

variable "service_plan_sku_name" {
  description = "App Service Plan SKU"
  type        = string
  default     = "EP1"
}

variable "storage_account_name" {
  description = "Storage account name for Function App"
  type        = string
}

variable "storage_account_access_key" {
  description = "Storage account access key"
  type        = string
  sensitive   = true
}

variable "app_settings" {
  description = "App settings"
  type        = map(string)
  default     = {}
}

variable "identity_type" {
  description = "Managed Identity type"
  type        = string
  default     = "SystemAssigned"
}

variable "tags" {
  description = "Resource tags"
  type        = map(string)
  default     = {}
}

# App Service Plan
resource "azurerm_service_plan" "main" {
  name                = "${var.name}-plan"
  resource_group_name = var.resource_group_name
  location            = var.location
  os_type             = var.os_type
  sku_name            = var.service_plan_sku_name
  
  tags = var.tags
}

# Linux Function App
resource "azurerm_linux_function_app" "main" {
  count = var.os_type == "Linux" ? 1 : 0
  
  name                       = var.name
  resource_group_name        = var.resource_group_name
  location                   = var.location
  service_plan_id            = azurerm_service_plan.main.id
  storage_account_name       = var.storage_account_name
  storage_account_access_key = var.storage_account_access_key
  
  site_config {
    application_stack {
      python_version = var.runtime == "python" ? var.version : null
      node_version   = var.runtime == "node" ? var.version : null
    }
    
    minimum_tls_version = "1.2"
    http2_enabled       = true
    
    cors {
      allowed_origins = ["https://portal.azure.com"]
    }
  }
  
  app_settings = var.app_settings
  
  identity {
    type = var.identity_type
  }
  
  tags = var.tags
}

output "id" {
  value = azurerm_linux_function_app.main[0].id
}

output "name" {
  value = azurerm_linux_function_app.main[0].name
}

output "default_hostname" {
  value = azurerm_linux_function_app.main[0].default_hostname
}

output "principal_id" {
  value = azurerm_linux_function_app.main[0].identity[0].principal_id
}
```

---

## üîê „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÁÆ°ÁêÜ

### GitHub Secrets

Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§„Å´ÂøÖË¶Å„Å™„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà:

| „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÂêç | Ë™¨Êòé | ÂèñÂæóÊñπÊ≥ï |
|--------------|------|---------|
| `AZURE_CREDENTIALS_DEV` | ÈñãÁô∫Áí∞Â¢ÉÁî®AzureË™çË®ºÊÉÖÂ†± | `az ad sp create-for-rbac` |
| `AZURE_CREDENTIALS_STG` | „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢ÉÁî® | Âêå‰∏ä |
| `AZURE_CREDENTIALS_PROD` | Êú¨Áï™Áí∞Â¢ÉÁî® | Âêå‰∏ä |
| `TEAMS_WEBHOOK_URL` | TeamsÈÄöÁü•Áî®Webhook | TeamsË®≠ÂÆö |
| `TERRAFORM_BACKEND_KEY` | Terraform State Backend Key | Azure Portal |

### AzureË™çË®ºÊÉÖÂ†±„ÅÆ‰ΩúÊàê

```bash
# „Çµ„Éº„Éì„Çπ„Éó„É™„É≥„Ç∑„Éë„É´‰ΩúÊàê
az ad sp create-for-rbac \
  --name "github-actions-sds2roster-prod" \
  --role contributor \
  --scopes /subscriptions/{subscription-id}/resourceGroups/rg-sds2roster-prod \
  --sdk-auth

# Âá∫Âäõ„ÇíGitHub Secrets„Å´ÁôªÈå≤
# AZURE_CREDENTIALS_PROD „Å®„Åó„Å¶‰øùÂ≠ò
```

### Key Vault„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà

„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åå‰ΩøÁî®„Åô„Çã„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà:

| „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÂêç | Ë™¨Êòé | Ë®≠ÂÆöÊñπÊ≥ï |
|--------------|------|---------|
| `upload-api-endpoint` | CSV Upload API „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà | ÊâãÂãïË®≠ÂÆö |
| `upload-api-key` | CSV Upload API „Ç≠„Éº | ÊâãÂãïË®≠ÂÆö |
| `table-storage-connection-string` | Table StorageÊé•Á∂öÊñáÂ≠óÂàó | TerraformËá™ÂãïË®≠ÂÆö |

---

## üöÄ „Éá„Éó„É≠„Ç§ÊâãÈ†Ü

### ÂàùÂõûÁí∞Â¢ÉÊßãÁØâ

#### 1. Terraform StateÁî®Storage Account‰ΩúÊàê

```bash
# Terraform State‰øùÂ≠òÁî®„ÅÆStorage Account‰ΩúÊàê
az group create \
  --name rg-terraform-state \
  --location japaneast

az storage account create \
  --name stterraformstate \
  --resource-group rg-terraform-state \
  --location japaneast \
  --sku Standard_ZRS

az storage container create \
  --name tfstate \
  --account-name stterraformstate
```

#### 2. TerraformÂàùÊúüÂåñ„ÉªÂÆüË°å

```bash
# ÈñãÁô∫Áí∞Â¢É
cd terraform/environments/dev
terraform init
terraform plan
terraform apply

# „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É
cd terraform/environments/stg
terraform init
terraform plan
terraform apply

# Êú¨Áï™Áí∞Â¢É
cd terraform/environments/prod
terraform init
terraform plan
terraform apply
```

#### 3. Function AppÂàùÂõû„Éá„Éó„É≠„Ç§

```bash
# PythonÁâà
cd src/python
func azure functionapp publish func-sds2roster-py-prod

# JavaScriptÁâà
cd src/javascript
npm run build
func azure functionapp publish func-sds2roster-js-prod
```

### ÈÄöÂ∏∏„Éá„Éó„É≠„Ç§ (CI/CDÁµåÁî±)

#### ÈñãÁô∫Áí∞Â¢É

```bash
# develop„Éñ„É©„É≥„ÉÅ„Å´push
git checkout develop
git add .
git commit -m "feat: add new feature"
git push origin develop

# GitHub Actions„ÅåËá™ÂãïÂÆüË°å
# - Lint & Test
# - Deploy to dev
# - Smoke tests
```

#### Êú¨Áï™Áí∞Â¢É

```bash
# main„Éñ„É©„É≥„ÉÅ„Å´„Éû„Éº„Ç∏
git checkout main
git merge develop
git push origin main

# „Åæ„Åü„ÅØ„ÄÅ„Çø„Ç∞‰ΩúÊàê
git tag -a v1.2.3 -m "Release v1.2.3"
git push origin v1.2.3

# GitHub Actions„ÅåÂÆüË°å
# - Security scan
# - Terraform plan
# - ÊâøË™çÂæÖ„Å° (ÊâãÂãïÊâøË™çÂøÖË¶Å)
# - Terraform apply
# - Function deploy (staging slot)
# - Slot swap
# - Post-deployment tests
```

### Á∑äÊÄ•„É≠„Éº„É´„Éê„ÉÉ„ÇØ

```bash
# Azure CLI„ÅßÊâãÂãï„É≠„Éº„É´„Éê„ÉÉ„ÇØ
az functionapp deployment slot swap \
  --resource-group rg-sds2roster-prod \
  --name func-sds2roster-py-prod \
  --slot production \
  --target-slot staging

az functionapp deployment slot swap \
  --resource-group rg-sds2roster-prod \
  --name func-sds2roster-js-prod \
  --slot production \
  --target-slot staging
```

---

## üìä „É¢„Éã„Çø„É™„É≥„Ç∞„Éª„Ç¢„É©„Éº„Éà

### „Éá„Éó„É≠„Ç§„É°„É≥„Éà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ

Application Insights„Åß‰ª•‰∏ã„ÇíÁõ£Ë¶ñ:

| „É°„Éà„É™„ÇØ„Çπ | Ê≠£Â∏∏ÁØÑÂõ≤ | „Ç¢„É©„Éº„ÉàÈñæÂÄ§ | „Ç¢„ÇØ„Ç∑„Éß„É≥ |
|----------|---------|------------|----------|
| „Éá„Éó„É≠„Ç§ÊàêÂäüÁéá | 100% | < 95% | TeamsÈÄöÁü• |
| „Éá„Éó„É≠„Ç§ÊôÇÈñì | < 10ÂàÜ | > 15ÂàÜ | Ë™øÊüª |
| FunctionËµ∑ÂãïÊôÇÈñì | < 30Áßí | > 60Áßí | „Çπ„Ç±„Éº„É´Ë™øÊï¥ |
| „Ç®„É©„ÉºÁéá („Éá„Éó„É≠„Ç§Âæå) | < 0.1% | > 5% | Ëá™Âãï„É≠„Éº„É´„Éê„ÉÉ„ÇØ |
| „É™„ÇØ„Ç®„Çπ„ÉàÂøúÁ≠îÊôÇÈñì | < 500ms | > 2Áßí | „Ç¢„É©„Éº„Éà |

### „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÈÄöÁü•

#### ÊàêÂäüÊôÇ

```
‚úÖ Deployment Success

Environment: Production
Version: v1.2.3
Deployed by: user@example.com
Duration: 8m 32s
Tests: All passed
Status: https://func-sds2roster-py-prod.azurewebsites.net/api/health
```

#### Â§±ÊïóÊôÇ

```
üö® Deployment Failed

Environment: Production
Version: v1.2.3
Failed at: Post-deployment tests
Error: Error rate > 5%
Action: Automatically rolled back
Previous version: v1.2.2 (restored)
```

---

## üîß „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞

### „Éá„Éó„É≠„Ç§Â§±ÊïóÊôÇ„ÅÆÂØæÂøú

#### 1. Terraform ApplyÂ§±Êïó

```bash
# „Ç®„É©„Éº„É≠„Ç∞Á¢∫Ë™ç
terraform show

# ÁâπÂÆö„É™„ÇΩ„Éº„Çπ„ÅÆ„ÅøÂÜç‰ΩúÊàê
terraform taint azurerm_linux_function_app.main
terraform apply

# Áä∂ÊÖã„Éï„Ç°„Ç§„É´Á¢∫Ë™ç
terraform state list
terraform state show azurerm_resource_group.main
```

#### 2. Function App „Éá„Éó„É≠„Ç§Â§±Êïó

```bash
# „Éá„Éó„É≠„Ç§„É≠„Ç∞Á¢∫Ë™ç
az webapp log tail \
  --name func-sds2roster-py-prod \
  --resource-group rg-sds2roster-prod

# App SettingsÁ¢∫Ë™ç
az functionapp config appsettings list \
  --name func-sds2roster-py-prod \
  --resource-group rg-sds2roster-prod

# ÂÜçËµ∑Âãï
az functionapp restart \
  --name func-sds2roster-py-prod \
  --resource-group rg-sds2roster-prod
```

#### 3. Slot SwapÂ§±Êïó

```bash
# Staging slotÁ¢∫Ë™ç
az functionapp show \
  --name func-sds2roster-py-prod \
  --resource-group rg-sds2roster-prod \
  --slot staging

# SwapÁä∂ÊÖãÁ¢∫Ë™ç
az functionapp deployment slot list \
  --name func-sds2roster-py-prod \
  --resource-group rg-sds2roster-prod

# ÊâãÂãï„ÅßSwapÂÆüË°å
az functionapp deployment slot swap \
  --resource-group rg-sds2roster-prod \
  --name func-sds2roster-py-prod \
  --slot staging \
  --target-slot production
```

---

## üìö Èñ¢ÈÄ£„Éâ„Ç≠„É•„É°„É≥„Éà

### „Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„Éâ„Ç≠„É•„É°„É≥„Éà
- [01_architecture_overview.md](./01_architecture_overview.md) - „Ç∑„Çπ„ÉÜ„É†„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£Ê¶ÇË¶Å
- [03_c4_container_diagram.md](./03_c4_container_diagram.md) - „Ç≥„É≥„ÉÜ„Éä„ÉºÊßãÊàê
- [06_security_architecture.md](./06_security_architecture.md) - „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠Ë®à

### Ë¶Å‰ª∂„Éâ„Ç≠„É•„É°„É≥„Éà
- [ÈùûÊ©üËÉΩË¶Å‰ª∂ÂÆöÁæ©](../requirements/03_non_functional_requirements.md)
- [„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ¶ÇË¶Å](../requirements/01_project_overview.md)

### Â§ñÈÉ®„É™„ÇΩ„Éº„Çπ
- [Azure Functions „Éá„Éó„É≠„Ç§„É°„É≥„Éà](https://learn.microsoft.com/azure/azure-functions/functions-deployment-technologies)
- [Terraform Azure Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [GitHub Actions for Azure](https://github.com/Azure/actions)

---

## üìù Â§âÊõ¥Â±•Ê≠¥

| „Éê„Éº„Ç∏„Éß„É≥ | Êó•‰ªò | Â§âÊõ¥ÂÜÖÂÆπ | Â§âÊõ¥ËÄÖ |
|-----------|------|---------|--------|
| 1.0.0 | 2025-10-27 | ÂàùÁâà‰ΩúÊàê | DevOps Engineer |

---

## üîç „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà

### „Éá„Éó„É≠„Ç§Ââç„ÉÅ„Çß„ÉÉ„ÇØ

- [ ] „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Çπ„Éà„Åå„Éë„Çπ„Åó„Å¶„ÅÑ„Çã
- [ ] „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≠„É£„É≥„ÅßÂïèÈ°å„Å™„Åó
- [ ] Terraform„Éó„É©„É≥„ÇíÁ¢∫Ë™çÊ∏à„Åø
- [ ] ÊâøË™çËÄÖ„ÅÆÊâøË™ç„ÇíÂèñÂæó
- [ ] „É≠„Éº„É´„Éê„ÉÉ„ÇØÊâãÈ†Ü„ÇíÁ¢∫Ë™ç
- [ ] Èñ¢‰øÇËÄÖ„Å´ÈÄöÁü•Ê∏à„Åø

### „Éá„Éó„É≠„Ç§Âæå„ÉÅ„Çß„ÉÉ„ÇØ

- [ ] Smoke tests„Åå„Éë„Çπ
- [ ] „Ç®„É©„ÉºÁéá„ÅåÊ≠£Â∏∏ÁØÑÂõ≤ÂÜÖ
- [ ] ÂøúÁ≠îÊôÇÈñì„ÅåÊ≠£Â∏∏ÁØÑÂõ≤ÂÜÖ
- [ ] Application Insights„ÅßÁï∞Â∏∏„Å™„Åó
- [ ] Function App„ÅåÊ≠£Â∏∏Ëµ∑Âãï
- [ ] Key Vault„Ç¢„ÇØ„Çª„ÇπÁ¢∫Ë™ç
- [ ] StorageÊé•Á∂öÁ¢∫Ë™ç
- [ ] „Éá„Éó„É≠„Ç§ÂÆå‰∫ÜÈÄöÁü•ÈÄÅ‰ø°
